name: Build & Release Android APK

on:
  push:
    tags:
      - "v*.*.*"   # e.g. v1.3.0

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true
          connect-timeout-seconds: 60

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version-file: pubspec.yaml 
          cache: true

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # ─────────────────────────────
      # Supabase CLI
      # ─────────────────────────────
      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: 2.67.1

      - name: Link Supabase project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}

      # ─────────────────────────────
      # Android signing
      # ─────────────────────────────
      - name: Decode Android keystore
        run: |
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 --decode > android/app/keystore.jks
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Create key.properties
        run: |
          cat > android/key.properties <<EOF
          storeFile=keystore.jks
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          EOF

      # ─────────────────────────────
      # Build
      # ─────────────────────────────
      - name: Create .env file
        run: |
          cat > .env <<EOF
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          EOF

      - name: Install dependencies
        run: flutter pub get

      - name: Build release APK
        run: flutter build apk --release --target-platform android-arm,android-arm64 --split-debug-info=build/symbols --obfuscate

      # ─────────────────────────────
      # Extract metadata
      # ─────────────────────────────
      - name: Extract version & checksum
        id: meta
        run: |
          APK=build/app/outputs/flutter-apk/app-release.apk

          VERSION_LINE=$(grep '^version:' pubspec.yaml)
          VERSION_NAME=$(echo "$VERSION_LINE" | cut -d'+' -f1 | awk '{print $2}')
          VERSION_CODE=$(echo "$VERSION_LINE" | cut -d'+' -f2)

          SHA256=$(sha256sum "$APK" | awk '{print $1}')

          echo "apk=$APK" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

      # ─────────────────────────────
      # Upload APK
      # ─────────────────────────────
      - name: Upload APK to Supabase Storage
        env:
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          supabase storage cp \
            --experimental \
            "${{ steps.meta.outputs.apk }}" \
            "ss:///app-updates/app-${{ steps.meta.outputs.version_name }}.apk"

      # ─────────────────────────────
      # Generate & upload latest.json
      # ─────────────────────────────
      - name: Generate latest.json
        run: |
          cat > latest.json <<EOF
          {
            "versionCode": ${{ steps.meta.outputs.version_code }},
            "versionName": "${{ steps.meta.outputs.version_name }}",
            "apkPath": "app-${{ steps.meta.outputs.version_name }}.apk",
            "sha256": "${{ steps.meta.outputs.sha256 }}"
          }
          EOF

      - name: Upload latest.json
        env:
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          supabase storage cp \
            --experimental \
            latest.json \
            "ss:///app-updates/metadata/latest.json"
