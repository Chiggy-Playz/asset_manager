name: Build & Release Android APK

on:
  push:
    tags:
      - "v*.*.*" # e.g. v1.3.0

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true
          connect-timeout-seconds: 60

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version-file: pubspec.yaml
          cache: true

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Set-up s5cmd
        uses: peak/action-setup-s5cmd@main

      - name: Install dbmate
        run: |
          npm install --save-dev dbmate
          npx dbmate --version

      # ─────────────────────────────
      # Android signing
      # ─────────────────────────────
      - name: Decode Android keystore
        run: |
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 --decode > android/app/keystore.jks
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Create key.properties
        run: |
          cat > android/key.properties <<EOF
          storeFile=keystore.jks
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          EOF

      # ─────────────────────────────
      # Build
      # ─────────────────────────────
      - name: Create .env file
        run: |
          cat > .env <<EOF
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          EOF

      - name: Install dependencies
        run: flutter pub get

      - name: Build release APK
        run: flutter build apk --release --target-platform android-arm,android-arm64 --split-debug-info=build/symbols --obfuscate

      # ─────────────────────────────
      # Extract metadata
      # ─────────────────────────────
      - name: Extract version & checksum
        id: meta
        run: |
          APK=build/app/outputs/flutter-apk/app-release.apk

          VERSION_LINE=$(grep '^version:' pubspec.yaml)
          VERSION_NAME=$(echo "$VERSION_LINE" | cut -d'+' -f1 | awk '{print $2}')
          VERSION_CODE=$(echo "$VERSION_LINE" | cut -d'+' -f2)

          SHA256=$(sha256sum "$APK" | awk '{print $1}')

          echo "apk=$APK" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

      # ─────────────────────────────
      # Run db migrations
      # ─────────────────────────────
      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}
        run: |
          npx dbmate status
          npx dbmate up

      # ─────────────────────────────
      # Generate latest.json
      # ─────────────────────────────
      - name: Generate latest.json
        run: |
          cat > latest.json <<EOF
          {
            "versionCode": ${{ steps.meta.outputs.version_code }},
            "versionName": "${{ steps.meta.outputs.version_name }}",
            "apkPath": "asset_manager-${{ steps.meta.outputs.version_name }}.apk",
            "sha256": "${{ steps.meta.outputs.sha256 }}"
          }
          EOF

      # ─────────────────────────────
      # Upload APK and latest.json to Supabase Storage
      # ─────────────────────────────
      - name: Upload APK and latest.json to Supabase Storage
        env:
          S3_ENDPOINT_URL: ${{ secrets.SUPABASE_STORAGE_ENDPOINT_URL }}
          AWS_REGION: ${{ secrets.SUPABASE_STORAGE_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.SUPABASE_STORAGE_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SUPABASE_STORAGE_SECRET_ACCESS_KEY }}
        run: |
          s5cmd cp \
            "${{ steps.meta.outputs.apk }}" \
            "s3://app-updates/asset_manager-${{ steps.meta.outputs.version_name }}.apk"
          s5cmd cp \
            latest.json \
            "s3://app-updates/metadata/latest.json"
